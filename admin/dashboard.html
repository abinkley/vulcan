<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Vulcan Cycling</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="css/admin.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <!-- Responsive Styles -->
  <link rel="stylesheet" href="../css/responsive.css">

  <!-- Mobile Navigation Script -->
  <script src="../js/mobile-nav.js" defer></script>

</head>
<body>
  <header class="admin-header">
    <div class="container">
      <div class="admin-header-content">
        <div class="logo">
          <a href="../index.html">
            <span>VULCAN CYCLING</span>
          </a>
          <span>Admin</span>
        </div>
        <nav>
          <ul>
            <li><a href="dashboard.html" class="active">Dashboard</a></li>
            <li><a href="add-content.html">Add Content</a></li>
            <li><a href="../index.html">View Site</a></li>
            <li><a href="#" id="logout-btn">Logout</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main class="admin-main">
    <div class="container">
      <div class="admin-content" style="grid-template-columns: 1fr; gap: 0;">
        <div class="admin-main-content">
          <div class="admin-header-actions">
            <h2>Content Management</h2>
            <a href="add-content.html" class="btn primary-btn">Add New Content</a>
          </div>
          
          <div style="margin-bottom: 20px;">
            <ul class="content-filters" style="display: flex; gap: 15px; margin-bottom: 20px;">
              <li><a href="#" class="active" data-filter="all">All Content</a></li>
              <li><a href="#" data-filter="news">News</a></li>
              <li><a href="#" data-filter="rider">Riders</a></li>
              <li><a href="#" data-filter="race">Races</a></li>
              <li><a href="#" data-filter="result">Results</a></li>
            </ul>
          </div>

          <div class="search-bar">
            <input type="text" id="content-search" placeholder="Search content...">
          </div>
          
          <div class="content-table-container">
            <table class="content-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="content-table-body">
                <tr>
                  <td colspan="5" class="loading-cell">Loading content...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD0hp0wbDPAG2Cbs_K1pi1jBDWtW4PMUuk",
      authDomain: "vulcan-edfea.firebaseapp.com",
      projectId: "vulcan-edfea",
      storageBucket: "vulcan-edfea.firebasestorage.app",
      messagingSenderId: "906189775089",
      appId: "1:906189775089:web:7ce445936dfbc556778950",
      measurementId: "G-5GZYY5YKTB"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize Firestore
    const db = firebase.firestore();
    
    // Initialize Auth
    const auth = firebase.auth();
    
    // Check authentication state
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Redirect to login page if not authenticated
        window.location.href = 'index.html';
      } else {
        // Load content if authenticated
        loadContent();
      }
    });
    
    // Logout function
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      }).catch(error => {
        console.error('Error signing out:', error);
      });
    });
    
    // Load content from Firestore
    async function loadContent(filter = 'all') {
      const tableBody = document.getElementById('content-table-body');
      tableBody.innerHTML = '<tr><td colspan="5" class="loading-cell">Loading content...</td></tr>';
      
      try {
        let query = db.collection('content');
        
        // Apply filter if not 'all'
        if (filter !== 'all') {
          query = query.where('type', '==', filter);
        }
        
        // Get content
        const snapshot = await query.orderBy('createdAt', 'desc').get();
        
        // Clear loading message
        tableBody.innerHTML = '';
        
        // If no content, show message
        if (snapshot.empty) {
          tableBody.innerHTML = '<tr><td colspan="5" class="empty-cell">No content found.</td></tr>';
          return;
        }
        
        // Add each content item to the table
        snapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          row.setAttribute('data-type', data.type);
          
          // Format date correctly without timezone shifts
          let formattedDate = 'N/A';
          
          if (data.date) {
            if (typeof data.date === 'string' && data.date.includes('-')) {
              // Parse YYYY-MM-DD directly without Date object conversion to avoid timezone issues
              const parts = data.date.split('-');
              if (parts.length === 3) {
                formattedDate = `${parts[1]}/${parts[2]}/${parts[0]}`; // MM/DD/YYYY format
              } else {
                formattedDate = data.date; // Use as-is if not in expected format
              }
            } else {
              // Fallback for non-string dates
              formattedDate = new Date(data.date).toLocaleDateString();
            }
          } else if (data.createdAt) {
            formattedDate = new Date(data.createdAt.toDate()).toLocaleDateString();
          }
          
          // Create row content
          row.innerHTML = `
            <td>${data.title || data.fullName || 'Untitled'}</td>
            <td><span class="badge ${data.type}">${data.type}</span></td>
            <td><span class="status ${data.status || 'draft'}">${data.status || 'draft'}</span></td>
            <td>${formattedDate}</td>
            <td class="actions">
              <a href="add-content.html?edit=${doc.id}&tab=${data.type}" class="action-btn edit-btn">Edit</a>
              <button class="action-btn delete-btn" data-id="${doc.id}">Delete</button>
            </td>
          `;
          
          // Add row to table
          tableBody.appendChild(row);
        });
        
        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', handleDelete);
        });
      } catch (error) {
        console.error('Error loading content:', error);
        tableBody.innerHTML = '<tr><td colspan="5" class="error-cell">Error loading content. Please try again.</td></tr>';
      }
    }
    
    // Handle content deletion
    async function handleDelete(e) {
      const id = e.target.getAttribute('data-id');
      
      if (!id) return;
      
      if (confirm('Are you sure you want to delete this content? This action cannot be undone.')) {
        try {
          await db.collection('content').doc(id).delete();
          
          // Remove the row from the table
          e.target.closest('tr').remove();
          
          // Show success message
          alert('Content deleted successfully.');
          
          // Reload content if table is empty
          const tableBody = document.getElementById('content-table-body');
          if (tableBody.children.length === 0) {
            loadContent(getCurrentFilter());
          }
        } catch (error) {
          console.error('Error deleting content:', error);
          alert('Error deleting content. Please try again.');
        }
      }
    }
    
    // Get current filter
    function getCurrentFilter() {
      const activeFilter = document.querySelector('.content-filters a.active');
      return activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
    }
    
    // Filter content
    document.querySelectorAll('.content-filters a').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Remove active class from all links
        document.querySelectorAll('.content-filters a').forEach(l => {
          l.classList.remove('active');
        });
        
        // Add active class to clicked link
        e.target.classList.add('active');
        
        // Load content with filter
        const filter = e.target.getAttribute('data-filter');
        loadContent(filter);
      });
    });
    
    // Search content
    document.getElementById('content-search').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#content-table-body tr');
      
      rows.forEach(row => {
        const title = row.querySelector('td:first-child')?.textContent.toLowerCase() || '';
        
        if (title.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
    
    // Load recent content
    function loadRecentContent() {
      const contentList = document.getElementById('recent-content-list');
      
      // Show loading indicator
      contentList.innerHTML = '<li class="loading">Loading recent content...</li>';
      
      // Query Firestore for most recent content
      db.collection('content')
        .orderBy('createdAt', 'desc')
        .limit(5)
        .get()
        .then(snapshot => {
          // Clear loading indicator
          contentList.innerHTML = '';
          
          if (snapshot.empty) {
            contentList.innerHTML = '<li class="empty">No content found.</li>';
            return;
          }
          
          // Loop through each document
          snapshot.forEach(doc => {
            const data = doc.data();
            
            // Format date correctly without timezone shifts
            let formattedDate = 'N/A';
            
            if (data.date) {
              if (typeof data.date === 'string' && data.date.includes('-')) {
                // Parse YYYY-MM-DD directly without Date object conversion to avoid timezone issues
                const parts = data.date.split('-');
                if (parts.length === 3) {
                  formattedDate = `${parts[1]}/${parts[2]}/${parts[0]}`; // MM/DD/YYYY format
                } else {
                  formattedDate = data.date; // Use as-is if not in expected format
                }
              } else {
                // Fallback for non-string dates
                formattedDate = new Date(data.date).toLocaleDateString();
              }
            } else if (data.createdAt) {
              formattedDate = new Date(data.createdAt.toDate()).toLocaleDateString();
            }
            
            // Create list item
            const li = document.createElement('li');
            li.innerHTML = `
              <div class="content-item">
                <div class="content-info">
                  <h3>${data.title || data.fullName || 'Untitled'}</h3>
                  <div class="content-meta">
                    <span class="badge ${data.type}">${data.type}</span>
                    <span class="date">${formattedDate}</span>
                  </div>
                </div>
                <div class="content-actions">
                  <a href="add-content.html?edit=${doc.id}&tab=${data.type}" class="action-btn edit-btn">Edit</a>
                </div>
              </div>
            `;
            
            // Add to list
            contentList.appendChild(li);
          });
        })
        .catch(error => {
          console.error('Error loading recent content:', error);
          contentList.innerHTML = '<li class="error">Error loading content.</li>';
        });
    }
  </script>
</body>
</html> 